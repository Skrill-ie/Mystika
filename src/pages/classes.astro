---
import BaseLayout from '../layouts/Layout.astro';
// import StudentSlot from '../assets/people.astro';
import PinLocation from "../assets/pin.astro";
import ClassDate from  "../assets/time.astro";


const response = await fetch('https://script.google.com/macros/s/AKfycbwwfhftO7HBvF75RLWSacSc4pCMQRfweq1pLumXn1saiuTnaE0x9HYmJP-fLJgoWQTX/exec',{
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
        action: 'fetchClasses'   })
});
const classes = await response.json();
---

<BaseLayout title="Classes">
    <div x-data="{ showForm: false, selectedClass: { id: null, name: '', image:'' } }">
        <div class="container mx-auto px-3">
            <ul class="gap-10 grid-cols-1 md:grid md:grid-cols-2 lg:grid-cols-3 my-10">
                {classes.map((cls) => (
                        <li x-data="{ shown: false }"
                            x-intersect.treshold.25="shown = true"
                            :class="shown ? 'translate-y-2 md:-translate-y-0 opacity-100' : 'translate-y-10 md:-translate-y-10 opacity-0'"
                            class="rounded transition-all transition duration-700 ease-in-out ">
                            <div class="bg-black-primary text-text-paragraph shadows hover:scale-110 hover:bg-black-primary hover:shadow-lg transition duration-150 ease-in-out ">
                                <div class="bg-cover bg-center relative h-80" style={`background-image: url('${cls["Header Image"]}')`}>
                                    <div class="absolute inset-0 bg-gradient-to-b from-black-primary/30 to-black-primary "></div>
                                    <div class="absolute bottom-0 left-0 p-5 w-full z-10">
                                        <div class="mb-5">
                                            <h3 class="text-4xl font-semibold">{cls.Name}</h3>
                                            <span class="opacity-65">"{cls["Sub Name"]}"</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <div>
                                                <p class="flex italic my-auto"> <span class="w-3 my-auto"><PinLocation/></span>&nbsp;&nbsp; <span class="opacity-65">{cls.Venue}</span></p>
                                                <div class="flex items-center"
                                                     x-data={`{
                                                        iso: '${cls.Date}',
                                                        get localTime() {
                                                          const date = new Date(this.iso);
                                                          return new Intl.DateTimeFormat('en-US', {
                                                            year: 'numeric',
                                                            month: 'long',
                                                            day: 'numeric',
                                                            hour: 'numeric',
                                                            minute: '2-digit',
                                                            hour12: true,
                                                            timeZone: 'Asia/Manila'
                                                          }).format(date);
                                                        }
                                                     }`}>
                                                    <span class="w-4 sflex my-auto"><ClassDate/></span>&nbsp;&nbsp;<p class="opacity-65 italic" x-text="localTime"></p>
                                                </div>
                                            </div>
                                            <div class="my-auto">
                                                <span class={`block rounded-full px-2 py-2.5 text-xs w-20 text-center uppercase 
                                                            ${cls.Status === 'Open' ? ' bg-linear-to-br from-lime-500 to-green-700 text-black shadow-green-700/30 shadow-lg' : 'bg-gray-500 text-text-paragraph'}`}>
                                                    {cls.Status}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-5">
                                    <div class="flex justify-between">
                                        <div>
                                            <span class="text-2xl">₱{cls.Price}.00</span>

                                        </div>
                                        <div class="my-auto  flex"> <span class="text-text-divider">Seats: &nbsp</span> <span>{cls["Student Slots"]}</span></div>
                                    </div>

                                    <p class="my-5 opacity-65">{cls.Description}</p>
                                    <button
                                            class={`bg-button-active w-full text-center px-5 py-2.5 rounded cursor-pointer
                                            ${cls.Status === 'Open' ? ' bg-text-divider text-text-paragraph' : 'bg-gray-500 text-text-paragraph opacity-50'}`}
                                            @click={`selectedClass = { id: '${cls.ID}', name: '${cls.Name}', image:'${cls["Header Image"]}' }; showForm = true`}
                                            disabled={cls.Status !== 'Open'}
                                    >
                                        <div key={cls.ID} x-data={`{ status: ${JSON.stringify(cls.Status)} }`}>
                                            <span x-show="status === 'Open'">Enroll Now</span>
                                            <span x-show="status !== 'Open'" x-text="status"></span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </li>
                ))}
            </ul>
        </div>
        <div x-show="showForm"
             x-cloak
             x-transition:enter="transition ease-out duration-500"
             x-transition:enter-start="opacity-0 translate-y-10"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-10"
             class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="flex md:min-w-3xl md:p-10 w-full justify-center">
                <div class="bg-cover bg-center relative min-w-60 hidden md:block" :style="`background-image: url('${selectedClass.image}')`">
                    <div class="absolute inset-0 bg-gradient-to-b from-black-primary/10 to-black-primary "></div>
                    <h2 class="absolute bottom-0 left-0 p-5 w-full z-10 text-text-paragraph">
                        <span class="text-sm">Enrolling in:</span><br> <span class="text-2xl font-bold text-text-divider" x-text="selectedClass.name"></span>
                    </h2>
                </div>
                <div class="bg-black px-10 py-20 shadow max-w-lg w-full h-screen overflow-x-hidden">
                    <div class="mb-10">
                        <h2 class="text-xl font-semibold text-text-divider mb-2">Let’s Get You Enrolled in <br><span class="text-3xl" x-text="selectedClass.name"></span></h2>
                        <p class="text-sm text-text-paragraph my-5 opacity-50">We just need a few details to save your spot.</p>
                    </div>
                    <form
                          @submit.prevent="submitForm"
                          x-data="{
                                studentName: '',
                                studentEmail:'',
                                studentNumber:'',
                                studentReceipt:'',
                                classId: selectedClass.id,
                                className: selectedClass.name,
                                step: 1,

                                isLoading: false,
                                submitForm() {
                                  this.isLoading = true;

                                  const payload = {
                                    name: this.studentName,
                                    email: this.studentEmail,
                                    contact: this.studentNumber,
                                    receipt: this.studentReceipt,
                                    classId: selectedClass.id,
                                    className: selectedClass.name,
                                    action: 'enrollStudent'
                                  };

                                  fetch('https://script.google.com/macros/s/AKfycbwwfhftO7HBvF75RLWSacSc4pCMQRfweq1pLumXn1saiuTnaE0x9HYmJP-fLJgoWQTX/exec', {
                                    method: 'POST',
                                    headers: {
                                      'Content-Type': 'application/x-www-form-urlencoded'
                                    },
                                    body: new URLSearchParams(payload)
                                  })
                                  .then(res => res.json())
                                  .then(data => {
                                    console.log('✅ Submitted to Google Sheets', data);
                                    alert('Successfully enrolled!');
                                    this.studentName = '';
                                    this.studentEmail = '';
                                    this.studentNumber = '';
                                    this.studentReceipt = '';
                                    this.classId = '';
                                    this.className = '';
                                    this.step = 1;
                                    showForm = false;
                                  })
                                  .catch(err => {
                                    console.error('❌ Submission failed', err);
                                    alert('Submission failed. Try again.');
                                  })
                                  .finally(() => this.isLoading = false);
                                }
                              }"
                          @submit.prevent="submitForm"
                    >

                        <!-- Hidden fields to pass to backend -->
                        <input type="hidden" name="class_id" x-model="classId" />
                        <input type="hidden" name="class_name" x-model="className" />

                        <div class="relative ">
                            <div x-show="step === 1"
                                 x-transition:enter="transition ease-out duration-500"
                                 x-transition:enter-start="opacity-0 -translate-x-full"
                                 x-transition:enter-end="opacity-100 translate-x-0"
                                 x-transition:leave="transition ease-in duration-300"
                                 x-transition:leave-start="opacity-100 translate-x-0"
                                 x-transition:leave-end="opacity-0 -translate-x-full"
                                 class="absolute top-0 left-0 w-full">

                                <div class="items-center flex flex-col">
                                    <label class="block mb-2 text-sm font-medium text-text-paragraph opacity-50 mt-5 text-center">Pay Gcash Via QR</label>
                                    <img class="max-w-50" src="/images/gcash.png"/>
                                </div>
                                <label class="block mb-2 text-sm font-medium text-text-paragraph opacity-50 mt-5">Gcash Reference Number</label>
                                <input class="bg-black-primary border text-text-paragraph/50 text-sm rounded-md focus:ring-text-divider focus:ring-text-divider block w-full px-10 p-2.5"
                                       type="text"
                                       name="student_receipt"
                                       x-model="studentReceipt"
                                       placeholder="Reference Number"
                                       required
                                />
                                <button type="button" @click="step = 2" class="border-1 border-button-active px-4 py-2 rounded w-full mt-2 mb-20">
                                    <span class="text-text-paragraph opacity-50">Proceed to Student Info</span>
                                </button>

                            </div>
                            <div x-show="step === 2"
                                 x-transition:enter="transition ease-out duration-500"
                                 x-transition:enter-start="opacity-0 translate-x-full"
                                 x-transition:enter-end="opacity-100 translate-x-0"
                                 x-transition:leave="transition ease-in duration-300"
                                 x-transition:leave-start="opacity-100 translate-x-0"
                                 x-transition:leave-end="opacity-0 translate-x-full"
                                 class="absolute top-0 left-0 w-full space-y-4">
                                <!-- Your visible form fields -->
                                <label class="block mb-2 text-sm font-medium text-text-paragraph opacity-50">Your Name</label>
                                <input
                                        class="bg-black-primary border text-text-paragraph/50 text-sm rounded-md focus:ring-text-divider focus:ring-text-divider block w-full px-10 p-2.5"
                                        type="text"
                                        name="student_name"
                                        x-model="studentName"
                                        placeholder="Your Name"
                                        required
                                />
                                <label class="block mb-2 text-sm font-medium text-text-paragraph opacity-50 mt-5">Your Email</label>
                                <input
                                        class="bg-black-primary border text-text-paragraph/50 text-sm rounded-md focus:ring-text-divider focus:ring-text-divider block w-full px-10 p-2.5"
                                        type="email"
                                        name="student_email"
                                        x-model="studentEmail"
                                        placeholder="Your Email"
                                        required
                                />
                                <label class="block mb-2 text-sm font-medium text-text-paragraph opacity-50 mt-5">Your Mobile</label>
                                <input class="bg-black-primary border text-text-paragraph/50 text-sm rounded-md focus:ring-text-divider focus:ring-text-divider block w-full px-10 p-2.5"
                                        type="text"
                                        name="student_number"
                                        x-model="studentNumber"
                                        placeholder="Your Mobile"
                                        required
                                />

                                <div class="flex flex-col mt-10">
                                    <button type="submit" :disabled="isLoading" class="text-text-paragraph bg-button-active w-full text-center px-5 py-1.5 rounded cursor-pointer">
                                        <span x-show="!isLoading">Submit</span>
                                        <span x-show="isLoading">Submitting...</span>
                                    </button>
                                    <button type="button" @click="step = 1" class="border-1 border-button-active text-white px-4 py-2 rounded w-full my-2">
                                       <span class="text-text-paragraph opacity-50">Go back</span>
                                    </button>
                                    <button type="button" @click="showForm = false" class="text-text-paragraph px-5 py-1.5 cursor-pointer mt-5 text-sm opacity-50 mb-20">Change My Mind</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</BaseLayout>


